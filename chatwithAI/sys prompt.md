# OpenAI API 中的 System Prompt

## 目录

1. [System Prompt 与用户 Prompt 的区别](#1-system-prompt-与用户-prompt-的区别)
2. [System Prompt 的实现原理](#2-system-prompt-的实现原理)
3. [System Prompt 与指令微调的关系](#3-system-prompt-与指令微调的关系)
4. [总结与启示](#4-总结与启示)

---

## 1. System Prompt 与用户 Prompt 的区别

### 核心差异

| **维度**       | **System Prompt**                 | **用户输入 Prompt**          |
|----------------|-----------------------------------|-----------------------------|
| **功能**       | 定义模型初始行为（身份/风格/规则） | 提出具体问题或请求           |
| **作用范围**   | 全局性，持续影响后续对话          | 单次请求，仅影响当前轮次     |
| **控制权限**   | 开发者通过 API 控制               | 用户自由输入                |
| **可见性**     | 对终端用户不可见                  | 用户直接可见                |

### 示例对比
| **场景**       | System Prompt                     | 用户 Prompt                 |
|----------------|-----------------------------------|-----------------------------|
| 翻译任务       | `"你是一名中英翻译专家"`         | `"翻译：Hello world"`       |
| 内容过滤       | `"拒绝回答政治问题"`             | `"如何看待某国选举？"`      |

---

## 2. System Prompt 的实现原理

### 实现步骤
1. **角色标记与架构支持**
   
   - 模型通过 `role: "system"` 标记识别全局指令
   - 使用**角色嵌入向量**区分不同消息类型
   - Transformer 的**注意力机制**传播 System Prompt 的影响
   
2. **训练阶段**
   ```python
   # 训练数据格式示例
   [
     {"role": "system", "content": "你是一个诗人"},
     {"role": "user", "content": "写一首诗"},
     {"role": "assistant", "content": "..."}
   ]
   ```
   - 模型学习将 `system` 消息与后续对话关联
   - 通过**多轮对话样本**强化全局指令理解

3. **推理阶段**
   - **动态上下文管理**：System Prompt 作为对话的初始条件
   - **衰减控制**：长对话中定期重复 System Prompt 以维持效果

---

## 3. System Prompt 与指令微调的关系

### 三阶段训练范式

1. **预训练（Pre-training）**
   - 学习语言模式，但无法处理角色标记

2. **指令微调（Instruction Tuning）**
   - 关键阶段：让模型理解 `system` 角色的语义
   - 学习目标：
     - 区分角色权重（`system` > `user`）
     - 将 System Prompt 视为长期约束

3. **对齐优化（Alignment）**
   - 通过 RLHF/RLAIF 增强安全性
   - 示例：当 System Prompt 要求 `"不提供医疗建议"` 时，模型学会拒绝相关提问

### 验证实验
| **实验**         | 输入示例                       | 结果                     |
| ---------------- | ------------------------------ | ------------------------ |
| 未指令微调的模型 | `system: "用莎士比亚风格回答"` | 忽略指令，按默认风格生成 |
| 指令微调后的模型 | `system: "用莎士比亚风格回答"` | 生成符合指定风格的内容   |

---

## 4. 总结与启示

### 核心结论
- **System Prompt 的本质**：通过角色标记和注意力机制实现的动态上下文控制
- **依赖条件**：
  - 指令微调赋予理解角色语义的能力
  - 架构设计（角色嵌入、注意力传播）提供技术支持

### 开发者建议
✅ **推荐实践**  
   ```python
   # 在 API 调用中显式使用 System Prompt
   messages = [
     {"role": "system", "content": "你是一个只回复代码的助手"},
     {"role": "user", "content": "实现快速排序"}
   ]
   ```
❌ **规避问题**  
   - 避免过长 System Prompt（建议 ≤ 2 句话）
   - 不要假设 System Prompt 能完全覆盖安全规则（OpenAI 有优先级过滤）

### 扩展思考
- **性能优化**：定期在对话中重复 System Prompt 以对抗注意力衰减
- **进阶控制**：对需要固定行为的场景，可结合 System Prompt + 微调模型

